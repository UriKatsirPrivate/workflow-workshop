# Sample input {"project": "uri-test"}
main:
    params: [args]
    steps:
    - List Zones:
        call: http.post
        args:
            url: https://us-central1-uri-test.cloudfunctions.net/ListZones
            auth:
                type: OIDC
            body:
                project: ${args.project}
        result: ResultList
    - define:
        assign:
        - array: ${ResultList.body.items}
        - result: ""
        - i: 0
    - check_condition:
        switch:
        - condition: ${len(array) > i}
          next: List Instances
        next: exit_loop
    # - iterate:
    #     assign:
    #         # - result: ${result + array[i].name + " - "}
    #         - i: ${i+1}
    #     next: check_condition
    - exit_loop:
        return:
            concat_result: ${result}   
    - List Instances:
        call: http.post
        args:
            url: https://us-central1-uri-test.cloudfunctions.net/ListInstances
            auth:
                type: OIDC
            body:
                project: ${args.project}
                zone: ${array[i].name}
        result: ResultList
    - Create Machine Image:
        try:
            call: http.post
            args:
                url: https://us-central1-uri-test.cloudfunctions.net/CreateMachineImages
                auth:
                    type: OIDC
                body:
                    project: ${args.project}
                    items: ${ResultList.body.items}
            result: ResultImages
            # next: iterate
        except:
            as: e
            steps:
                - All Errors:
                    next: iterate
    - iterate:
        assign:
            # - result: ${result + array[i].name + " - "}
            - i: ${i+1}
        next: check_condition                
    # - returnValue:
    #     return: ${ResultImages.body}