# Sample input {"project": "uri-test"}
main:
    params: [args]
    steps:
    - List Zones:
        call: http.post
        args:
            url: https://us-central1-uri-test.cloudfunctions.net/ListZones
            auth:
                type: OIDC
            body:
                project: ${args.project}
        result: ResultList
    - Loop All Zones:
        for:
            value: zone
            in: ${ResultList.body.zones}
            steps:
                - List Instances:
                    call: http.post
                    args:
                        url: https://us-central1-uri-test.cloudfunctions.net/ListInstances
                        auth:
                            type: OIDC
                        body:
                            project: ${args.project}
                            zone: ${zone}
                    result: InstanceList
                - Create Machine Image:
                    try:
                        call: http.post
                        args:
                            url: https://us-central1-uri-test.cloudfunctions.net/CreateMachineImages
                            auth:
                                type: OIDC
                            body:
                                project: ${args.project}
                                items: ${InstanceList.body.items}
                        result: ResultImages
                    except:
                        as: e
                        steps:
                             - All Errors: # Fake exception handling
                                assign:
                                    - i: 1
    - No More Zones:
        return:
            "Workflow Completed Successfully"